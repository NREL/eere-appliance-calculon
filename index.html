<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Appliance Energy Calculator</title>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css" rel="stylesheet" media="all">

    <link href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/css/bootstrap-select.min.css" rel="stylesheet" media="all">

    <link href="client/css/styles.css" rel="stylesheet">


</head>
<body>

<div class="container">
    <div class="row">
        <div class="col-sm-4 col-sm-offset-4">

<div id="app">
<div class="title">Appliance Energy Calculator</div>

<div class="input-group active">
    <span class="input-group-addon" id="watts-addon"><i class="fa fa-lightbulb-o"></i></span>
    <label for="appliances">My appliance</label>
    <select
        id="appliances"
        class="form-control"
        data-live-search="true"
        data-live-search-placeholder="Search the appliance list">
    </select>
</div>


<div class="input-group watts-group">
    <span class="input-group-addon" id="watts-addon"><i class="fa fa-bolt"></i></span>
    <label for="watts">Wattage</label>
    <input id="watts" class="form-control integer-input" value="24" type="number" min="0" step="1">
</div>


<div class="input-group states-group">
    <span class="input-group-addon" id="state-addon"><i class="fa fa-money"></i></span>
    <label for="states">Utility rate</label>
    <select
        id="states"
        class="form-control"
        data-show-subtext="true"
        aria-describedby="state-addon">
    </select>
</div>


<div class="input-group hours-group">
    <span class="input-group-addon" id="hours-addon"><i class="fa fa-clock-o"></i></span>
    <label for="hours">Hours used per day</label>
    <input id="hours" class="form-control integer-input" value="0" type="number" min="0" step="1">
</div>


<div class="input-group days-group">
    <span class="input-group-addon" id="days-addon"><i class="fa fa-calendar"></i></span>
    <label for="days">Days used per year</label>
    <input id="days" class="form-control integer-input" value="0" type="number" min="0" step="1">
</div>


<div class="results">
    <div class="header">Energy use and cost per year</div>
    <div class="results-row">
        <div class="data" id="energy"></div>
        <div class="data" id="cost"></div>
    </div>
</div>
    </div><!-- /app -->

        </div>
    </div>
</div>


<!-- Libraries -->
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.7.3/js/bootstrap-select.min.js"></script>

<script src="//cdnjs.cloudflare.com/ajax/libs/handlebars.js/3.0.3/handlebars.min.js"></script>


<!-- Templates -->
<script id="appliance-template" type="text/x-handlebars-template">
    {{#each appliances}}
    <option value="{{watts}}">{{appliance}}</option>
    {{/each}}
</script>

<script id="state-template" type="text/x-handlebars-template">
    {{! value and subtext are added later via AJAX on demand }}
    <option value="12" data-subtext="$0.12/kWh" data-state-code="{{code}}">US Average</option>
    {{#each states}}
    <option value="" data-subtext="" data-state-code="{{code}}">{{state}}</option>
    {{/each}}
</script>

<!-- Data -->
<script id="appliance-data"  type="application/json">
    {
        "appliances" : [
            { "appliance" : "Aquarium Equipment" , "watts" : "24"},
            { "appliance" : "Boom Box" , "watts" : "8"},
            { "appliance" : "Cable Box" , "watts" : "140"},
            { "appliance" : "CD Player" , "watts" : "7"},
            { "appliance" : "Ceiling Fan (only fan motor)" , "watts" : "35"},
            { "appliance" : "Clothes Dryer" , "watts" : "999999"},
            { "appliance" : "Clothes Washer" , "watts" : "999999"},
            { "appliance" : "Coffee Maker" , "watts" : "1000"},
            { "appliance" : "Compactors" , "watts" : "400"},
            { "appliance" : "Computer - Desktop PC" , "watts" : "75"},
            { "appliance" : "Computer - Notebook PC" , "watts" : "25"},
            { "appliance" : "Deep Fryer" , "watts" : "1000"},
            { "appliance" : "Desktop Computer Monitor" , "watts" : "42"},
            { "appliance" : "Dishwasher" , "watts" : "999999"},
            { "appliance" : "DVD/VCR" , "watts" : "17"},
            { "appliance" : "Electric blanket" , "watts" : "400"},
            { "appliance" : "Electronic air cleaner/filter" , "watts" : "50"},
            { "appliance" : "Freezer" , "watts" : "999999"},
            { "appliance" : "Furnace Fan" , "watts" : "295"},
            { "appliance" : "Garage door opener" , "watts" : "400"},
            { "appliance" : "Hair Dryer" , "watts" : "710"},
            { "appliance" : "Humidifier" , "watts" : "11"},
            { "appliance" : "Iron" , "watts" : "1100"},
            { "appliance" : "Lawn Sprinkler" , "watts" : "11"},
            { "appliance" : "Microwave Oven" , "watts" : "1500"},
            { "appliance" : "Monitor" , "watts" : "84"},
            { "appliance" : "Pool Pump" , "watts" : "1000"},
            { "appliance" : "Portable Spa" , "watts" : "4350"},
            { "appliance" : "Printer (inkjet)" , "watts" : "13"},
            { "appliance" : "Printer (laser)" , "watts" : "250"},
            { "appliance" : "Printer/Fax/multi-function device (inkjet)" , "watts" : "18"},
            { "appliance" : "Receiver" , "watts" : "28"},
            { "appliance" : "Rechargeable Power Tool" , "watts" : "13"},
            { "appliance" : "Refrigerator-Freezer" , "watts" : "999999"},
            { "appliance" : "Router/DSL/Cable Model" , "watts" : "6"},
            { "appliance" : "Television set-top box" , "watts" : "20"},
            { "appliance" : "Slow cooker" , "watts" : "200"},
            { "appliance" : "Space Heater" , "watts" : "1320"},
            { "appliance" : "Stereo Systems" , "watts" : "33"},
            { "appliance" : "Television, Analog, <40 inch" , "watts" : "86"},
            { "appliance" : "Television, Analog, >40 inch" , "watts" : "156"},
            { "appliance" : "Television, Digital, ED/HD TV, <40 inch" , "watts" : "150"},
            { "appliance" : "Television, Digital, ED/HD TV, >40 inch" , "watts" : "234"},
            { "appliance" : "Toaster  " , "watts" : "1100"},
            { "appliance" : "Toaster Oven" , "watts" : "1051"},
            { "appliance" : "Torchiere Lamp-Halogen" , "watts" : "300"},
            { "appliance" : "Television, CRT - Projection" , "watts" : "225"},
            { "appliance" : "Television, CRT" , "watts" : "60"},
            { "appliance" : "Television, DLP" , "watts" : "175"},
            { "appliance" : "Television, LCD" , "watts" : "150"},
            { "appliance" : "Television, Plasma" , "watts" : "300"},
            { "appliance" : "Vacuum" , "watts" : "542"},
            { "appliance" : "Video Game System" , "watts" : "36"},
            { "appliance" : "Water Heater-Family of 2" , "watts" : "4500"},
            { "appliance" : "Water Heater-Family of 4" , "watts" : "4500"},
            { "appliance" : "Waterbed Heater" , "watts" : "350"},
            { "appliance" : "Well Pump" , "watts" : "725"}
        ]
    }
</script>

<script id="state-data"  type="application/json">
    {
        "states" : [
            { "code" : "AL" , "state" : "Alabama" },
            { "code" : "AK" , "state" : "Alaska" },
            { "code" : "AZ" , "state" : "Arizona" },
            { "code" : "AR" , "state" : "Arkansas" },
            { "code" : "CA" , "state" : "California" },
            { "code" : "CO" , "state" : "Colorado" },
            { "code" : "CT" , "state" : "Connecticut" },
            { "code" : "DE" , "state" : "Delaware" },
            { "code" : "FL" , "state" : "Florida" },
            { "code" : "GA" , "state" : "Georgia" },
            { "code" : "HI" , "state" : "Hawaii" },
            { "code" : "ID" , "state" : "Idaho" },
            { "code" : "IL" , "state" : "Illinois" },
            { "code" : "IN" , "state" : "Indiana" },
            { "code" : "IA" , "state" : "Iowa" },
            { "code" : "KS" , "state" : "Kansas" },
            { "code" : "KY" , "state" : "Kentucky" },
            { "code" : "LA" , "state" : "Louisiana" },
            { "code" : "ME" , "state" : "Maine" },
            { "code" : "MD" , "state" : "Maryland" },
            { "code" : "MA" , "state" : "Massachusetts" },
            { "code" : "MI" , "state" : "Michigan" },
            { "code" : "MN" , "state" : "Minnesota" },
            { "code" : "MS" , "state" : "Mississippi" },
            { "code" : "MO" , "state" : "Missouri" },
            { "code" : "MT" , "state" : "Montana" },
            { "code" : "NE" , "state" : "Nebraska" },
            { "code" : "NV" , "state" : "Nevada" },
            { "code" : "NH" , "state" : "New Hampshire" },
            { "code" : "NJ" , "state" : "New Jersey" },
            { "code" : "NM" , "state" : "New Mexico" },
            { "code" : "NY" , "state" : "New York" },
            { "code" : "NC" , "state" : "North Carolina" },
            { "code" : "ND" , "state" : "North Dakota" },
            { "code" : "OH" , "state" : "Ohio" },
            { "code" : "OK" , "state" : "Oklahoma" },
            { "code" : "OR" , "state" : "Oregon" },
            { "code" : "PA" , "state" : "Pennsylvania" },
            { "code" : "RI" , "state" : "Rhode Island" },
            { "code" : "SC" , "state" : "South Carolina" },
            { "code" : "SD" , "state" : "South Dakota" },
            { "code" : "TN" , "state" : "Tennessee" },
            { "code" : "TX" , "state" : "Texas" },
            { "code" : "UT" , "state" : "Utah" },
            { "code" : "VT" , "state" : "Vermont" },
            { "code" : "VA" , "state" : "Virginia" },
            { "code" : "WA" , "state" : "Washington" },
            { "code" : "WV" , "state" : "West Virginia" },
            { "code" : "WI" , "state" : "Wisconsin" },
            { "code" : "WY" , "state" : "Wyoming" }
        ]
    }
</script>

<script>
$(document).ready(function(){

    // DOM caching
    var $controls = $('.form-control')
      , $inputgroups = $('.input-group')
      , $appliances = $('#appliances')
      , $watts= $('#watts')
      , $hours= $('#hours')
      , $days = $('#days')
      , $states = $('#states')
      , $energy = $('#energy')
      , $cost = $('#cost')
      , $integers = $('.integer-input')


    // set up our templating
    applianceTmplSrc = $('#appliance-template').html()
    applianceTemplate = Handlebars.compile( applianceTmplSrc )
    applianceHtml = applianceTemplate( JSON.parse( $('#appliance-data').html() ) )
    $appliances.append( applianceHtml )


    // prevent FOUC
    $appliances.wrap( function() {
        var h = $( this ).css('height')
        return '<div style="height: ' + h + '" class="fouc-placeholder"></div>'
    })

    $appliances.addClass('selectpicker')
    $appliances.removeClass('invisible')

    stateTmplSrc = $('#state-template').html()
    stateTemplate = Handlebars.compile( stateTmplSrc )
    stateHtml = stateTemplate( JSON.parse( $('#state-data').html() ) )
    $states.append( stateHtml )

    $states.wrap( function() {
        var h = $( this ).css('height')
        return '<div style="height: ' + h + '" class="fouc-placeholder"></div>'
    })

    $states.addClass('selectpicker')
    $states.removeClass('invisible')



    var apiConfig = {
        url: 'http://api.eia.gov/series/'
      , api_key: '4A8DA35AF7501244A974E9603C4FF11B'
      , series_id: 'ELEC.PRICE.XX-RES.Q'
    }


    /**
     *   Toggle focus/active state visual
     */
    var setActiveState = function( $group ){
        $inputgroups.removeClass('active')
        $group.addClass('active')
    }



    /**
     *  Calculate energy use and cost in the widget results box
     */
    var recalculate = function(){
        console.log('Recalculating')

        var energy = 0
          , cost   = 0
          , completed = false

        $controls.each( function(){
            return (completed = $(this).val() ? true : false)
        });

        if (completed) {
            energy = $watts.val() * $hours.val() *  $days.val()
            cost = energy * $states.val() / 100 // convert to $

            $energy.html(  energy + ' kWh')
            $cost.html( '$' + cost )
        }
    }

    /**
     *  Get utility rate data from EIA API
     */
    var getStateRate = function( statecode ){

        var series_id = apiConfig.series_id.replace( 'XX', statecode )

        return $.ajax({
            type: 'GET'
          , dataType: 'json'
          , url: apiConfig.url
          , data: {
                api_key: apiConfig.api_key
              , series_id: series_id
            }
        });

    }

    /**
     *  Restrict the type=number <inputs> to integers
     */
    $integers.on( 'change', function(event){
        event.currentTarget.value = Math.round(event.currentTarget.value)
    })

    /**
     *  Helper function
     *  Update DOM option data attr for bootstrap-select
     */
    var updateSubtext = function( rate, index ){
        $states.find('option:eq('+index+')').data('subtext', '$0.'+rate+'/kWh');
        $states.selectpicker('refresh');
    }

    /**
     *  Update the utility rate info displayed in the bootstrap-select dropdown and button
     */
    $states.on( 'change', function( event ){

        var state = event.currentTarget
          , optnum = state.selectedIndex
          , option = state[ optnum ]
          , statecode = option.dataset.stateCode
          , jqxhr = new $.Deferred
          , rate

        if (!option.value) {

            jqxhr = getStateRate( statecode )

            jqxhr.done( function(results){
                rate = Math.round( results.series[0].data[0][1] )
                option.value = rate
                updateSubtext( rate, optnum )
                recalculate()
            })

            jqxhr.fail( function(){ alert('Error fetching rate data')})

        } else {
            rate = option.value
            updateSubtext( rate, optnum )
        }

    })


    /**
     *  When the user changes appliances, update the wattage to match the new appliance
     */
    $( '#appliances' ).on( 'change', function( event ){
        console.log( 'setting watts to ' , event.currentTarget.value )
        $watts.val( event.currentTarget.value )
    })


    /**
     *  When the user changes any control, recalculate the totals
     *  Delegate the binding for bootstrap-select
     */
    $( '#app' ).on( 'change', '.form-control', function( event ){
        recalculate()
    })


    /**
     *  When the user focuses on any control, highlight the whole parent group visually
     *  Delegate the binding for bootstrap-select
     */
    $( '#app' ).on( 'focus', '.form-control', function( event ){
        var $group = $(event.currentTarget).parents('.input-group')
        setActiveState($group)
    })

});

</script>


</body>
</html>